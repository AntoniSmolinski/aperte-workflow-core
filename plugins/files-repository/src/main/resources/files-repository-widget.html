<#assign null = "null"/><#assign processInstanceId = process.getId()!""/><#assign processAssignee = task.assignee!""/><#assign userLogin = user.getLogin()!""/><#assign mode = privileges?seq_contains("EDIT")?string("edit", "view")/><#if mode != "edit">    <#assign mode = privileges?seq_contains("MIXED")?string("mixed", "view")/>    <#if mode != "mixed">        <#assign mode = "view"/>    </#if></#if><#if mode = "mixed">    <#if processAssignee != userLogin>        <#assign mode = "view"/>    </#if></#if><#assign deleteAreYouSure = messageSource.getMessage("widget.file.repository.results.table.delete.areYouSure")/><#assign updateDescriptionAreYouSure = messageSource.getMessage("widget.file.repository.results.table.updateDescription.areYouSure")/><#assign updateDescriptionSuccess = messageSource.getMessage("widget.file.repository.results.table.updateDescription.success")/><!-- Important: macros fileTableTr fileTableTrJs should not be formated due to javascript processor lack of new lines handling --><#macro fileTableTr fileId fileName fileDescription fileCreateDate fileCreatorLogin><tr class="file-tr-l-${fileCreatorLogin}-l"><td class="fileId" style="display:none">${fileId}</td> <td class="fileName"><a href="#" target="_blank" class="fileNameDownloadHref">${fileName}</a></td> <td class="fileDescription"><span class="editableText">${fileDescription!}</span></td> <td class="fileCreateDate">${fileCreateDate}</td><td>${fileCreatorLogin}</td></td><td><button class="btn btn-xs downloadFileBtn" style="margin-right: 10px;"alt="${messageSource.getMessage('widget.file.repository.results.table.downloadBtn')}"><span class="glyphicon glyphicon-floppy-save"/></button> <button class="btn btn-xs deleteFileBtn" style="margin-right: 10px;"alt="${messageSource.getMessage('widget.file.repository.results.table.deleteBtn')}"><span class="glyphicon glyphicon-remove"/></button> </td> </tr></#macro><#macro fileTableTrJs><@fileTableTr fileId="%%fileId%%" fileName="%%fileName%%" fileDescription="%%fileDescription%%" fileCreateDate="%%fileCreateDate%%" fileCreatorLogin="%%fileCreatorLogin%%"/></#macro><!-- The fileinput-button span is used to style the file input field as button --><br/><span class="btn btn-success fileinput-button" style="display:none;">  <i class="glyphicon glyphicon-plus"></i>  <span>${messageSource.getMessage("widget.file.repository.form.addFileBtn")}</span>  <!-- The file input field used as target for the file upload widget -->  <input id="fileupload" type="file" name="files[]"></span><br/><br/><!-- The container for the uploaded files --><div id="files" class="files"></div><!-- The global progress bar --><div id="progress" class="progress" style="display:none;">    <div class="progress-bar progress-bar-success"></div></div><table cellpadding="0" cellspacing="0" border="0" id="files-table" class="table table-hover table-bordered">    <thead>    <tr>        <th class="id" style="display:none">${messageSource.getMessage("widget.file.repository.results.table.id")}        </th>        <th class="name" style="width: 40px">${messageSource.getMessage("widget.file.repository.results.table.name")}        </th>        <th class="description" style="width: 120px">            ${messageSource.getMessage("widget.file.repository.results.table.description")}        </th>        <th class="createDate" style="width: 80px">            ${messageSource.getMessage("widget.file.repository.results.table.createdDate")}        </th>        <th class="creatorLogin" style="width: 80px">            ${messageSource.getMessage("widget.file.repository.results.table.creatorLogin")}        </th>        <th style="width: 30px">${messageSource.getMessage("widget.file.repository.results.table.fileAction")}</th>    </tr>    </thead>    <tbody>    <#list processInstanceFiles as file>        <@fileTableTr fileId=file.id?c fileName=file.name fileDescription=file.description!        fileCreateDate=file.createDate fileCreatorLogin=file.creatorLogin/>    </#list>    </tbody></table><script>    var oTable;    function downloadURL(url) {        var hiddenIFrameID = 'hiddenDownloader',                iframe = document.getElementById(hiddenIFrameID);        if (iframe === null) {            iframe = document.createElement('iframe');            iframe.id = hiddenIFrameID;            iframe.style.display = 'none';            document.body.appendChild(iframe);        }        iframe.src = url;    }    function getNoReplyDispatcherPortletFor(action) {        var controller = 'filescontroller';        var noReplyDispatcherPortlet = dispatcherPortlet.replace('=dispatcher&','=noReplyDispatcher&');        var url = noReplyDispatcherPortlet + '&controller=' + controller + '&action=' + action + '&processInstanceId=${processInstanceId}'        return url;    }    function getDispatcherPortletFor(action) {        var controller = 'filescontroller';        var url = dispatcherPortlet + '&controller=' + controller + '&action=' + action + '&processInstanceId=${processInstanceId}'        return url;    }    // Change this to the location of your server-side upload handler:    var urlUploadFile = getDispatcherPortletFor('uploadFile'),            urlGetFilesList = getDispatcherPortletFor('getFilesList'),            urlDownloadFile = getNoReplyDispatcherPortletFor('downloadFile'),            urlDeleteFile = getDispatcherPortletFor('deleteFile'),            urlUpdateDescription = getDispatcherPortletFor('updateDescription');    function initTable() {        $('.downloadFileBtn').unbind("click").on('click', function (e) {            e.preventDefault();            var row = $(this).closest('tr');            var itemId = row.find('td.fileId').text();            console.log('Download: itemId=' + itemId);            downloadURL(urlDownloadFile + '&filesRepositoryItemId=' + itemId);        });        $('.deleteFileBtn').unbind("click").on('click', function (e) {            e.preventDefault();            var row = $(this).closest('tr');            var itemId = row.find('td.fileId').text();            var fileName = row.find('td.fileName').text();            var msgConfirm = '${deleteAreYouSure}';            msgConfirm = msgConfirm.replace('{0}', fileName);            console.log('Delete: itemId=' + itemId);            console.log('Delete: fileName=' + fileName);            if (confirm(msgConfirm)) {                $.getJSON(urlDeleteFile + '&filesRepositoryItemId=' + itemId)                        .done(function (data) {                            if (data.errors.length > 0) {                                $(data.errors).each(function (index) {                                    alert('Error: ' + data.errors[index].source + '\n\nDetails:\n' + data.errors[index].message);                                });                                return;                            }                            row.remove();                        });            }        });        $('#files-table tr').each(function() {            var aHref = $(this).find('.fileNameDownloadHref');            var itemId = aHref.closest('tr').find('td.fileId').text();            console.log(itemId);            var url = urlDownloadFile + '&filesRepositoryItemId=' + itemId;            console.log('xxxxxxxxxxxxx begin');            console.log(url);            console.log('xxxxxxxxxxxxx end');            aHref.attr('href', encodeURI(url));            makeEditableOnClick($(this));        });    }    function saveDescriptionBtnClick(e) {        e.preventDefault();        var row = $(this).closest('tr');        var itemId = row.find('td.fileId').text();        var description = row.find('input.description-text').val();        var fileName = row.find('td.fileName').text();        console.log('Modify desc: itemId=' + itemId);        console.log('Modify desc: description=' + description);        console.log('Modify desc: fileName=' + fileName);        $.getJSON(urlUpdateDescription + '&filesRepositoryItemId=' + itemId + '&fileDescription=' + description)                .done(function (data) {                    if (data.errors.length > 0) {                        $(data.errors).each(function (index) {                            alert('Error: ' + data.errors[index].source + '\n\nDetails:\n' + data.errors[index].message);                        });                        return;                    }                    var msgSuccess = '${updateDescriptionSuccess}';                    msgSuccess = msgSuccess.replace('{0}', fileName);                    console.log(msgSuccess);                    var tdDesc = $(row.find('td.fileDescription')[0]);                    tdDesc.empty();                    tdDesc.append($("<span class='editableText'/>").append(description));                    var tr = $(tdDesc.closest('tr'));                    makeEditableOnClick(tr);                });    }    function makeEditableOnClick(tr) {        var editableTextSpan = tr.find('span.editableText');        var editDescHtml = '<div class="input-group input-group-sm"> <input type="text" class="description-text form-control"> <span class="input-group-btn"> <button class="btn btn-default description-change-btn" type="button">${messageSource.getMessage("widget.file.repository.results.table.saveBtn")}</button> </span> </div>'        var editDesc = $(editDescHtml);        editDesc.find('input.description-text').val(editableTextSpan.text());        editableTextSpan.closest('td').unbind('click').on('click', function(e) {            e.preventDefault();            editableTextSpan.empty();            editableTextSpan.append(editDesc);            editableTextSpan.find('.description-change-btn').unbind("click").on('click', saveDescriptionBtnClick);            $(this).unbind('click');        });    }    $(document).ready(function () {        var widget = new Widget('${widgetName}', '${widgetId}', '${task.internalTaskId}');        widget.getData = function() {return {};};        widget.validate = function() {return [];};        widget.isEnabled = "${mode}" == "view" ? false : true;        widgets.push(widget);        if("${mode}" == "view")        {            $('input.description-text').attr('readonly', true);            $('button.description-change-btn').prop('disabled', true);            $('button.deleteFileBtn').prop('disabled', true).hide();        } else {            $('.fileinput-button').show();        }        if("${mode}" == "mixed")        {            var rowsToDisable = $('#files-table').find('tr[class^="file-tr-l"]:not(tr[class="file-tr-l-${userLogin}-l"])');            $(rowsToDisable).find('input.description-text').attr('readonly', true);            $(rowsToDisable).find('button.description-change-btn').prop('disabled', true);            $(rowsToDisable).find('button.deleteFileBtn').prop('disabled', true).hide();        }        initTable();        $('#fileupload').fileupload({            url: urlUploadFile,            dataType: 'json',            autoUpload: true        })        .on('fileuploadadd', function (e, data) {            data.context = $('<div/>').appendTo('#files');                })        .on('fileuploadprocessalways', function (e, data) {            var index = data.index,                    file = data.files[index],                    node = $(data.context.children()[index]);            if (file.preview) {                node                        .prepend('<br>')                        .prepend(file.preview);            }            if (file.error) {                node                        .append('<br>')                        .append($('<span class="text-danger"/>').text(file.error));            }            if (index + 1 === data.files.length) {                data.context.find('button')                        .text('Upload')                        .prop('disabled', !!data.files.error);            }        })        .on('fileuploadprogressall', function (e, data) {            $('#progress').show();            var progress = parseInt(data.loaded / data.total * 100, 10);            $('#progress .progress-bar').css(                    'width',                    progress + '%'            );        })        .on('fileuploaddone',function (e, dataObj) {            $('#progress').hide();            data = dataObj.jqXHR.responseJSON;            if (data.errors.length > 0) {                $(data.errors).each(function (index) {                    alert('Error: ' + data.errors[index].source + '\n\nDetails:\n' + data.errors[index].message);                });                return;            }            var file = data.data;            var newRowTrHtml = '<@fileTableTrJs/>'                    .replace(new RegExp('%%fileId%%', 'g'), file.id)                    .replace(new RegExp('%%fileName%%', 'g'), file.name)                    .replace(new RegExp('%%fileDescription%%', 'g'), file.description != null ? file.description : "")                    .replace(new RegExp('%%fileCreateDate%%', 'g'), file.createDate)                    .replace(new RegExp('%%fileCreatorLogin%%', 'g'), file.creatorLogin);            var newRowTr = $(newRowTrHtml);            console.log(file);            console.log(newRowTr);            makeEditableOnClick(newRowTr);            newRowTr.find('span.editableText').closest('td').click();            $('#files-table').append(newRowTr);            initTable();        }).on('fileuploadfail',function (e, data) {            if (data.errors.length > 0) {                $(data.errors).each(function (index) {                    alert('Error: ' + data.errors[index].source + '\n\nDetails:\n' + data.errors[index].message);                });                return;            }        }).prop('disabled', !$.support.fileInput)        .parent().addClass($.support.fileInput ? undefined : 'disabled');    });</script>